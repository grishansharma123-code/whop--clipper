<script>
    // 1. Check for Key before opening
    document.getElementById("upload_widget").addEventListener("click", () => {
        const key = document.getElementById('gemini-key').value;
        if(!key || key === "AIzaSyDapDi-vNZnCgf-CdFx5x-P_oWfE93FEUk") {
            alert("Please paste your real Gemini API Key first!");
            return;
        }
        myWidget.open();
    });

    var myWidget = cloudinary.createUploadWidget({
        cloudName: 'dozlfqmtj', 
        uploadPreset: 'whop_clipper',
        clientAllowedFormats: ["mp4", "mov"],
        // IMPORTANT: This tells the cloud to start the AI subtitles immediately
        raw_convert: 'google_speech' 
    }, (error, result) => { 
        if (!error && result && result.event === "success") { 
            document.getElementById('status').innerText = "ðŸ¤– AI is analyzing & transcribing...";
            const originalUrl = result.info.secure_url;
            
            // MASTER TRANSFORMATION
            // c_fill,g_auto:face = Smart vertical crop
            // fn_captions = AI Subtitles
            // fl_attachment = Forces Download
            const transform = "c_fill,g_auto:face,ar_9:16,so_0,eo_30/fn_captions:google:en-US:roboto_28_bold_yellow/fl_attachment/";
            const clipUrl = originalUrl.replace("/upload/", `/upload/${transform}`);
            
            // Increased to 15 seconds because AI Transcription takes time
            let count = 15;
            const timer = setInterval(() => {
                count--;
                document.getElementById('status').innerText = `âœ¨ AI is writing subtitles... ${count}s`;
                if(count <= 0) {
                    clearInterval(timer);
                    showResult(clipUrl);
                }
            }, 1000);
        }
    });

    function showResult(url) {
        document.getElementById('status').innerText = "ðŸ”¥ REEL READY!";
        document.getElementById('preview-container').style.display = 'block';
        
        const vid = document.getElementById('preview');
        vid.src = url;
        // This ensures the video plays immediately
        vid.load();
        vid.play();

        document.getElementById('download-area').innerHTML = `
            <a href="${url}" class="download-btn" download>ðŸ“¥ DOWNLOAD FOR INSTAGRAM</a>
        `;
    }
</script>
